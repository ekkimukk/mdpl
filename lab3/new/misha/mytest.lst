     1                                  %define STDIN 0;   ввод - клава
     2                                  %define STDOUT 1;  вывод- экран
     3                                  %define SYS_WRITE  0x01
     4                                  %define SYS_READ   0x00
     5                                  
     6                                  section .data
     7                                  ;                       <<<     DATA     >>>
     8                                      ;----------------------------------------------------------
     9                                      
    10 00000000 496E7075742076616C-         msg_1 db 'Input values:', 0xa, 0
    10 00000009 7565733A0A00       
    11                                      len_1 equ $ - msg_1
    12                                  
    13 0000000F 61203D2000                  msg_2 db 'a = ', 0
    14                                      len_2 equ $ - msg_2
    15                                  
    16 00000014 62203D2000                  msg_3 db 'b = ', 0
    17                                      len_3 equ $ - msg_3
    18                                      
    19 00000019 526573756C743A0A00          msg_4 db 'Result:', 0xa, 0
    20                                      len_4 equ $ - msg_4
    21                                  
    22 00000022 0A4552524F52212054-         msg_5 db 0xa, 'ERROR! Try again', 0xa
    22 0000002B 727920616761696E0A 
    23                                      len_5 equ $ - msg_5
    24                                      
    25                                      ;----------------------------------------------------------
    26                                      ;Буфер
    27 00000034 07                          len_inp db 7                ;ввод max 6 символов (-32768) + '/n'
    28 00000035 0C                          len_out db 12               ;вывод max 11 символов (-2147483648) + '/n'
    29 00000036 00                          len_cur db 0                ;реальная длина
    30 00000037 00                          sign db 0                   ;знак числа
    31                                      
    32 00000038 00<rep Ch>                  buffer times 12 db 0        ;введенные символы
    33                                      
    34                                      ;----------------------------------------------------------
    35                                      ;Переменные
    36 00000044 0000                        a dw 0
    37 00000046 0000                        b dw 0
    38 00000048 00000000                    res dd 0
    39                                  
    40                                  section .text
    41                                  global _start
    42                                  
    43                                  ;                        <<<     MAIN     >>>
    44                                  _start:
    45                                      ;----------------------------------------------------------
    46                                      ;Вывод 1-го сообщения
    47 00000000 48BE-                       mov rsi, msg_1              ;message to write
    47 00000002 [0000000000000000] 
    48 0000000A BA0F000000                  mov rdx,len_1               ;message length
    49 0000000F E88B000000                  call write
    50                                      
    51                                      ;----------------------------------------------------------
    52                                      ;Вывод 2-го сообщения
    53 00000014 48BE-                       mov rsi, msg_2
    53 00000016 [0F00000000000000] 
    54 0000001E BA05000000                  mov rdx, len_2
    55 00000023 E877000000                  call write
    56                                      
    57                                      ;----------------------------------------------------------
    58                                      ;Ввод a
    59 00000028 E87F000000                  call read
    60 0000002D E8C2000000                  call to_int                 ;преобразовать 'a' в число
    61 00000032 66890425[44000000]          mov word [a], ax            ; -> 'a'
    62 0000003A E85F000000                  call test
    63 0000003F E88D000000                  call buffer_cl              ;очистка буфера
    64                                      
    65                                      ;----------------------------------------------------------
    66                                      ;Вывод 3-го сообщения
    67 00000044 48BE-                       mov rsi, msg_3
    67 00000046 [1400000000000000] 
    68 0000004E BA05000000                  mov rdx,len_3
    69 00000053 E847000000                  call write
    70                                      
    71                                      ;----------------------------------------------------------
    72                                      ;Ввод b
    73 00000058 E84F000000                  call read
    74 0000005D E892000000                  call to_int
    75 00000062 66890425[46000000]          mov word [b], ax            ; -> 'b'
    76 0000006A E82F000000                  call test
    77 0000006F E85D000000                  call buffer_cl
    78                                      
    79                                      ;----------------------------------------------------------
    80                                      ;Рассчет значений
    81 00000074 E89A010000                  call culculate              ; -> 'res'
    82 00000079 E820000000                  call test
    83 0000007E E800010000                  call to_str                 ;преобразовать 'res' в строку
    84                                      
    85                                      ;----------------------------------------------------------
    86                                      ;Вывод результата
    87 00000083 48BE-                       mov rsi, buffer
    87 00000085 [3800000000000000] 
    88 0000008D 8A1425[36000000]            mov dl, byte [len_cur]
    89 00000094 E806000000                  call write
    90                                  
    91                                      ;----------------------------------------------------------
    92                                      ;Выод из программы
    93 00000099 E869010000                  call exit
    94                                  
    95                                  
    96                                  ;                        <<<     FUNC     >>>
    97                                  test:
    98 0000009E C3                          ret
    99                                  ;--------------------------------------------------------------
   100                                  ;Функция вывода
   101                                  write:
   102 0000009F B801000000                  mov rax, SYS_WRITE  ;sys_write()
   103 000000A4 BF01000000                  mov rdi, STDOUT     ;file descriptor (stdout)
   104 000000A9 0F05                        syscall
   105 000000AB C3                          ret
   106                                  
   107                                  ;--------------------------------------------------------------
   108                                  ;Функция ввода
   109                                  read:
   110 000000AC B800000000                  mov eax, SYS_READ   ;sys_read()
   111 000000B1 BF00000000                  mov rdi, STDIN      ;file descriptor (stdin)
   112 000000B6 48BE-                       mov rsi, buffer     ;message to write
   112 000000B8 [3800000000000000] 
   113 000000C0 BA[34000000]                mov edx, len_inp    ;message length
   114 000000C5 0F05                        syscall             ;execute read(0, buffer, buf_size)
   115 000000C7 FEC8                        dec al
   116 000000C9 880425[36000000]            mov byte [len_cur], al
   117 000000D0 C3                          ret
   118                                  
   119                                  ;--------------------------------------------------------------
   120                                  ;Очистка буфера
   121                                  buffer_cl:
   122 000000D1 31C9                        xor ecx, ecx
   123 000000D3 8A0C25[36000000]            mov cl, byte [len_cur]
   124 000000DA B800000000                  mov eax, 0
   125                                      clear:
   126 000000DF 67C680[38000000]00              mov byte [buffer + eax], ''
   127 000000E7 FFC0                            inc eax
   128 000000E9 E2F4                            loop clear
   129 000000EB C60425[36000000]00          mov byte [len_cur], 0
   130 000000F3 C3                          ret
   131                                      
   132                                  ;--------------------------------------------------------------
   133                                  ;Функции преобраования в число
   134                                  to_int:
   135 000000F4 C60425[37000000]00          mov byte [sign], 0
   136 000000FC BA00000000                  mov edx, 0	                ;edx -> адрес строки
   137 00000101 678A9A[38000000]            mov bl, [buffer + edx] 	    ;bl  -> первый символ строки
   138 00000108 80FB2D                      cmp bl,'-'
   139 0000010B 7513                        jne int_no_sign
   140 0000010D FFC2                        inc edx                     ;'+' адрес строки
   141 0000010F FEC8                        dec al                      ;'-' длина строки
   142 00000111 880425[36000000]            mov byte [len_cur], al
   143 00000118 C60425[37000000]01          mov byte [sign], 1 
   144                                      
   145                                  int_no_sign:
   146 00000120 31C9                        xor ecx, ecx
   147 00000122 66BF0A00                    mov di,10                   ;di -> мноитель
   148 00000126 8A0C25[36000000]            mov cl, [len_cur]           ;cx -> счётчик цикла
   149                                      ;jecxz studw_error	        ;длина = 0 -> ошибка
   150                                      
   151 0000012D 4831C0                      xor rax,rax
   152 00000130 4831DB                      xor rbx,rbx
   153                                      
   154                                  next_symb:
   155 00000133 678A9A[38000000]                mov bl, [buffer + edx]  ;bl -> символ строки
   156 0000013A FFC2                            inc edx                 ;'+' адрес
   157 0000013C 80FB30                          cmp bl,'0'
   158 0000013F 0F8CA9000000                    jl error                ;код символа < '0' -> ошибка
   159 00000145 80FB39                          cmp bl,'9'
   160 00000148 0F8FA0000000                    jg error                ;код символа > '9' -> ошибка
   161 0000014E 80EB30                          sub bl,'0'              ;преобразование в число
   162 00000151 52                              push rdx
   163 00000152 66F7E7                          mul di                  ;ax -> ax * 10
   164 00000155 5A                              pop rdx
   165 00000156 0F8292000000                    jc error	            ;результат > 2^16  -> ошибка
   166 0000015C 6601D8                          add ax, bx
   167 0000015F 0F8289000000                    jc error	            ;переполнение      -> ошибка
   168 00000165 E2CC                        loop next_symb	            ;цикл
   169 00000167 8A1425[37000000]            mov dl, byte [sign]
   170 0000016E 84D2                        test dl, dl
   171 00000170 740A                        jz int_plus
   172 00000172 663D0080                    cmp ax, 32768	            ;модуль отр.числа  <= 32768
   173 00000176 7776                        ja error	                ;больше            -> ошибка
   174 00000178 66F7D8                      neg ax
   175 0000017B C3                          ret
   176                                      
   177                                  int_plus:
   178 0000017C 663DFF7F                    cmp ax,32767	            ;пол.число  <= 32767
   179 00000180 776C                        ja error                    ;больше            -> ошибка
   180 00000182 C3                          ret
   181                                  
   182                                  ;--------------------------------------------------------------
   183                                  ;Функции преобраования в строку
   184                                  to_str:
   185 00000183 C60425[37000000]00          mov byte [sign], 0
   186 0000018B 8B0425[48000000]            mov eax, dword [res]
   187 00000192 B900000000                  mov ecx, 0
   188 00000197 85C0                        test eax, eax               ;проверка знака
   189 00000199 BB0A000000                  mov ebx, 10
   190 0000019E 790A                        jns str_no_sign
   191 000001A0 C60425[37000000]01          mov byte [sign], 1          ;добавление знака
   192 000001A8 F7D8                        neg eax
   193                                  str_no_sign:
   194 000001AA 31D2                        xor edx, edx		        ;обнуление старшей части двойного слова
   195 000001AC F7F3                        div ebx		                ;edx:eax / ebx
   196 000001AE 6683C230                    add dx,'0'		            ;преобразование в код символа
   197 000001B2 6652                        push dx		                ;сохранение в стек
   198 000001B4 FFC1                        inc ecx
   199 000001B6 85C0                        test eax, eax		        ;проверка AX
   200 000001B8 75F0                        jnz str_no_sign             ;частное не 0 -> икл
   201                                  if_sing_str:
   202 000001BA 8A1425[37000000]            mov dl, byte [sign]
   203 000001C1 84D2                        test dl, dl
   204 000001C3 740A                        jz str
   205 000001C5 67C680[38000000]2D          mov byte [buffer + eax], '-'
   206 000001CD FFC0                        inc eax
   207                                  str:		                    ;икл из стека
   208 000001CF 665A                        pop dx
   209 000001D1 678890[38000000]            mov byte [buffer + eax],dl
   210 000001D8 FFC0                        inc eax		                ;'+' адрес буфера
   211 000001DA E2F3                        loop str
   212 000001DC 67C680[38000000]0A          mov byte [buffer + eax], 0x0a
   213 000001E4 FFC0                        inc eax
   214 000001E6 880425[36000000]            mov byte [len_cur], al
   215 000001ED C3                          ret
   216                                  
   217                                  ;--------------------------------------------------------------
   218                                  ;Функция вывода ошибки   
   219                                  error:
   220 000001EE 48BE-                       mov rsi, msg_5
   220 000001F0 [2200000000000000] 
   221 000001F8 BA12000000                  mov rdx,len_5
   222 000001FD E89DFEFFFF                  call write
   223 00000202 E800000000                  call exit
   224                                      
   225                                  ;--------------------------------------------------------------
   226                                  ;Функция выода из прораммы
   227                                  exit:
   228 00000207 BB00000000                  mov ebx, 0
   229 0000020C B83C000000                  mov rax,60                  ;sys_exit()
   230 00000211 0F05                        syscall
   231                                      
   232                                      
   233                                  ;                        <<<     CALC     >>>
   234                                  culculate:
   235 00000213 4831C0                      xor rax, rax
   236 00000216 4831DB                      xor rbx, rbx
   237 00000219 4831C9                      xor rcx, rcx
   238 0000021C 4831D2                      xor rdx, rdx
   239                                          ; a*b/11     , a > b
   240                                          ; 11  , a = b
   241                                          ; a*a/b , a < b
   242 0000021F 668B0425[44000000]              mov ax, word [a]
   243 00000227 668B1C25[46000000]              mov bx, word [b]
   244 0000022F 6639D8                          cmp ax, bx
   245 00000232 7708                            ja @bg
   246 00000234 7411                            je @eq
   247 00000236 F7E8                    	    imul   eax            ; edx:eax = a*a
   248 00000238 F7FB                        	idiv   ebx            ; eax = a*a/b
   249 0000023A EB10                            jmp @end_if
   250                                          ; a > b
   251                                          @bg:
   252 0000023C F7EB                    	        imul   ebx           ; eax:edx = a*b
   253 0000023E B90B000000              	        mov    ecx,    11    ; ecx = 11
   254 00000243 F7F9                            	idiv   ecx           ; eax:edx / eax
   255 00000245 EB05                            	jmp @end_if
   256                                          ; a = b
   257                                          @eq:
   258 00000247 B80B000000                          mov eax, 11
   259                                          @end_if:
   260 0000024C 890425[48000000]                mov dword [res], eax
   261 00000253 C3                              ret
